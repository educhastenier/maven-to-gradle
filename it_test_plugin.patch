From b0d7dc95a2e581616f42637a77f6788f08d6620e Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@bonitasoft.com>
Date: Mon, 16 Jul 2018 10:37:00 +0200
Subject: [PATCH] create plugin for integration tests SP

---
 .../gradle/IntegrationTestExtension.groovy    |  6 ++
 .../gradle/IntegrationTestSPPlugin.groovy     | 61 +++++++++++++++++++
 .../bonita-integration-cluster/build.gradle   | 20 ++----
 .../build.gradle                              | 12 ++--
 .../build.gradle                              | 30 ++-------
 subscription/bonita-test-api-sp/build.gradle  | 15 +++--
 6 files changed, 93 insertions(+), 51 deletions(-)
 create mode 100644 buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy
 create mode 100644 buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy

diff --git a/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy
new file mode 100644
index 0000000000..344ffa7383
--- /dev/null
+++ b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy
@@ -0,0 +1,6 @@
+package com.bonitasoft.engine.gradle
+
+class IntegrationTestExtension {
+
+    String include
+}
diff --git a/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy
new file mode 100644
index 0000000000..3c3dc4beec
--- /dev/null
+++ b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy
@@ -0,0 +1,61 @@
+package com.bonitasoft.engine.gradle
+
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.Task
+import org.gradle.api.tasks.Copy
+import org.gradle.api.tasks.testing.Test
+
+class IntegrationTestSPPlugin implements Plugin<Project> {
+    @Override
+    void apply(Project project) {
+
+        def integrationTestExt = project.extensions.create("integrationTest", IntegrationTestExtension)
+        def slowTestExt = project.extensions.create("slowTest", IntegrationTestExtension)
+        def unitTestExt = project.extensions.create("unitTest", IntegrationTestExtension)
+        project.afterEvaluate {
+            if (!integrationTestExt.include && !slowTestExt.include) {
+                project.logger.info("No integration test suite configured. no test task created, kept default.")
+                return
+            }
+            project.configurations {
+                lic
+            }
+            project.dependencies {
+                lic 'org.bonitasoft.security:test-licenses:1.12.2@zip'
+            }
+            project.test {
+                include unitTestExt.include ?: ''
+            }
+            def extractLicenses = project.tasks.create(name: "extractLicenses", type: Copy) {
+                from project.zipTree(project.configurations.lic.resolvedConfiguration.resolvedArtifacts.first().file)
+                into "${project.buildDir}/lic"
+            }
+            if (integrationTestExt.include) {
+                createItTask(project, "integrationTest", integrationTestExt.include, extractLicenses)
+            }
+            if (slowTestExt.include) {
+                createItTask(project, "slowTest", slowTestExt.include, extractLicenses)
+            }
+        }
+
+
+    }
+
+    private Task createItTask(Project project, String integrationTest, tests, extractLicenses) {
+        project.tasks.create(name: integrationTest, type: Test) {
+            group "Verification"
+            description "Run integration test suite: $integrationTest"
+            include tests
+            systemProperty 'bonita.client.home', "${project.buildDir}/lic/performance"
+            dependsOn extractLicenses
+
+            def testDir = new File(project.buildDir, integrationTest)
+            workingDir = testDir
+            doFirst {
+                testDir.mkdirs()
+                new File(testDir, "target").mkdir()
+            }
+        }
+    }
+}
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle
index 04c122761a..2fd229f6f6 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle
@@ -1,6 +1,7 @@
-/*
- * This file was generated by the Gradle 'init' task.
- */
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
+
 
 dependencies {
     testCompile project(':subscription:bonita-integration-tests-sp:bonita-integration-tests-client')
@@ -14,15 +15,6 @@ dependencies {
     testCompile 'ch.qos.logback:logback-classic:1.2.3'
 }
 group = 'com.bonitasoft.engine.test'
-test {
-  include ''
-}
-task integrationTest(type: Test) {
-  include 'com/bonitasoft/engine/ClusteredTestSuiteIT.class'
-  def testDir = new File(buildDir, "test")
-  workingDir = testDir
-  doFirst {
-    testDir.mkdirs()
-    new File(testDir, "target").mkdir()
-  }
+integrationTest {
+    include 'com/bonitasoft/engine/ClusteredTestSuiteIT.class'
 }
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle
index 3180c5297b..3c0ac310b6 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle
@@ -1,6 +1,6 @@
-/*
- * This file was generated by the Gradle 'init' task.
- */
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
 
 dependencies {
     testCompile project(':engine:bpm:bonita-api:bonita-server-api-http')
@@ -12,8 +12,6 @@ dependencies {
 
 group = 'com.bonitasoft.engine.test'
 description = 'HTTP API Integration Tests on Embedded Jetty - SP'
-test {
-  include ''
-}
-task integrationTest(type: Test) {
+integrationTest {
+  include '**/*IT.class'
 }
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle
index 9f60ce35a8..6aa1bd8831 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle
@@ -1,10 +1,7 @@
-/*
- * This file was generated by the Gradle 'init' task.
- */
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
 
-configurations {
-    lic
-}
 dependencies {
     compile project(':subscription:bonita-test-api-sp')
     compile project(':subscription:bpm:bonita-server-sp')
@@ -15,7 +12,6 @@ dependencies {
     runtime 'org.slf4j:jcl-over-slf4j:1.7.25'
     testCompile 'org.awaitility:awaitility:2.0.0'
     testCompile project(':engine:bpm:bonita-deploy:bonita-deploy-tcp')
-    lic 'org.bonitasoft.security:test-licenses:1.12.2@zip'
 }
 
 task testsJar(type: Jar) {
@@ -26,23 +22,9 @@ task testsJar(type: Jar) {
 group = 'com.bonitasoft.engine.test'
 publishing.publications.maven.artifact(testsJar)
 
-task extractLicence(type: Copy) {
-    from zipTree(configurations.lic.resolvedConfiguration.resolvedArtifacts.first().file)
-    into "${project.buildDir}/lic"
-}
-
-test {
-    include ''
-}
-
-task integrationTest(type: Test) {
+integrationTest {
     include 'com/bonitasoft/engine/LocalIntegrationTestsSP.class'
-    systemProperty 'bonita.client.home', "${project.buildDir}/lic/performance"
 }
-
-task slowTest(type: Test) {
-    include 'com/bonitasoft/engine/SlowExecutionLocalIntegrationTests.class'
-    systemProperty 'bonita.client.home', "${project.buildDir}/lic/performance"
+slowTest {
+    include 'com/bonitasoft/engine/SlowExecutionLocalIntegrationTestsSP.class'
 }
-tasks.integrationTest.dependsOn extractLicence
-tasks.slowTest.dependsOn extractLicence
diff --git a/subscription/bonita-test-api-sp/build.gradle b/subscription/bonita-test-api-sp/build.gradle
index 27f61cb414..9cc368298a 100644
--- a/subscription/bonita-test-api-sp/build.gradle
+++ b/subscription/bonita-test-api-sp/build.gradle
@@ -1,6 +1,10 @@
-/*
- * This file was generated by the Gradle 'init' task.
- */
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
+
+configurations {
+    lic
+}
 
 dependencies {
     compile project(':engine:bonita-test-api')
@@ -16,11 +20,10 @@ dependencies {
     testCompile 'com.microsoft.sqlserver:mssql-jdbc:7.0.0.jre8'
 }
 
-test {
+unitTest {
     include '**/EngineStarterSPIT.class'
 }
-
-task integrationTest(type: Test) {
+integrationTest {
     include '**/TestEngineSPIT.class'
 }
 
-- 
2.20.1

