From d6660eddedc13bea8ab778388e57090b930d17c2 Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@bonitasoft.com>
Date: Mon, 16 Jul 2018 10:37:00 +0200
Subject: [PATCH] create plugin for integration tests SP

---
 .../gradle/IntegrationTestExtension.groovy    |  6 ++
 .../gradle/IntegrationTestSPPlugin.groovy     | 61 +++++++++++++++++++
 .../bonita-integration-cluster/build.gradle   | 14 ++---
 .../build.gradle                              | 11 ++--
 .../build.gradle                              | 11 ++--
 .../build.gradle                              | 28 +++------
 subscription/bonita-test-api-sp/build.gradle  | 15 +++--
 7 files changed, 103 insertions(+), 43 deletions(-)
 create mode 100644 buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy
 create mode 100644 buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy

diff --git a/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy
new file mode 100644
index 0000000000..344ffa7383
--- /dev/null
+++ b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestExtension.groovy
@@ -0,0 +1,6 @@
+package com.bonitasoft.engine.gradle
+
+class IntegrationTestExtension {
+
+    String include
+}
diff --git a/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy
new file mode 100644
index 0000000000..3c3dc4beec
--- /dev/null
+++ b/buildSrc/src/main/groovy/com/bonitasoft/engine/gradle/IntegrationTestSPPlugin.groovy
@@ -0,0 +1,61 @@
+package com.bonitasoft.engine.gradle
+
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.Task
+import org.gradle.api.tasks.Copy
+import org.gradle.api.tasks.testing.Test
+
+class IntegrationTestSPPlugin implements Plugin<Project> {
+    @Override
+    void apply(Project project) {
+
+        def integrationTestExt = project.extensions.create("integrationTest", IntegrationTestExtension)
+        def slowTestExt = project.extensions.create("slowTest", IntegrationTestExtension)
+        def unitTestExt = project.extensions.create("unitTest", IntegrationTestExtension)
+        project.afterEvaluate {
+            if (!integrationTestExt.include && !slowTestExt.include) {
+                project.logger.info("No integration test suite configured. no test task created, kept default.")
+                return
+            }
+            project.configurations {
+                lic
+            }
+            project.dependencies {
+                lic 'org.bonitasoft.security:test-licenses:1.12.2@zip'
+            }
+            project.test {
+                include unitTestExt.include ?: ''
+            }
+            def extractLicenses = project.tasks.create(name: "extractLicenses", type: Copy) {
+                from project.zipTree(project.configurations.lic.resolvedConfiguration.resolvedArtifacts.first().file)
+                into "${project.buildDir}/lic"
+            }
+            if (integrationTestExt.include) {
+                createItTask(project, "integrationTest", integrationTestExt.include, extractLicenses)
+            }
+            if (slowTestExt.include) {
+                createItTask(project, "slowTest", slowTestExt.include, extractLicenses)
+            }
+        }
+
+
+    }
+
+    private Task createItTask(Project project, String integrationTest, tests, extractLicenses) {
+        project.tasks.create(name: integrationTest, type: Test) {
+            group "Verification"
+            description "Run integration test suite: $integrationTest"
+            include tests
+            systemProperty 'bonita.client.home', "${project.buildDir}/lic/performance"
+            dependsOn extractLicenses
+
+            def testDir = new File(project.buildDir, integrationTest)
+            workingDir = testDir
+            doFirst {
+                testDir.mkdirs()
+                new File(testDir, "target").mkdir()
+            }
+        }
+    }
+}
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle
index be76248cae..264012320c 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-cluster/build.gradle
@@ -1,3 +1,6 @@
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
 group = 'com.bonitasoft.engine.test'
 description = ''
 dependencies {
@@ -11,15 +14,6 @@ dependencies {
     testCompile group: 'ch.qos.logback', name: 'logback-core', version:'1.2.3'
     testCompile group: 'ch.qos.logback', name: 'logback-classic', version:'1.2.3'
 }
-test {
-  include ''
-}
-task integrationTest(type: Test) {
+integrationTest {
   include 'com/bonitasoft/engine/ClusteredTestSuiteIT.class'
-  def testDir = new File(buildDir, "test")
-  workingDir = testDir
-  doFirst {
-    testDir.mkdirs()
-    new File(testDir, "target").mkdir()
-  }
 }
\ No newline at end of file
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-ejb-api-sp/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-ejb-api-sp/build.gradle
index be3fd8fe41..1cfafd1627 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-ejb-api-sp/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-ejb-api-sp/build.gradle
@@ -1,11 +1,14 @@
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
+
 group = 'com.bonitasoft.engine.test'
 description = ''
 dependencies {
   compile project(':engine:bonita-integration-tests:bonita-integration-tests-as:bonita-integration-ejb-api')
   testCompile project(':subscription:bpm:bonita-server-sp')
 }
-test {
-  include ''
-}
-task integrationTest(type: Test) {
+
+integrationTest {
+  include '**/*IT.class'
 }
\ No newline at end of file
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle
index 584743a95e..79bd747e06 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-as/bonita-integration-http-api-sp/build.gradle
@@ -1,3 +1,7 @@
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
+
 group = 'com.bonitasoft.engine.test'
 description = 'HTTP API Integration Tests on Embedded Jetty - SP'
 dependencies {
@@ -7,8 +11,7 @@ dependencies {
     testCompile group: 'org.eclipse.jetty', name: 'jetty-server', version:'9.4.9.v20180320'
     testCompile group: 'org.eclipse.jetty', name: 'jetty-servlet', version:'9.4.9.v20180320'
 }
-test {
-  include ''
-}
-task integrationTest(type: Test) {
+
+integrationTest {
+  include '**/*IT.class'
 }
\ No newline at end of file
diff --git a/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle b/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle
index 428b5cc25a..491b9f4e80 100644
--- a/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle
+++ b/subscription/bonita-integration-tests-sp/bonita-integration-tests-local/build.gradle
@@ -1,9 +1,10 @@
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
+
 group = 'com.bonitasoft.engine.test'
 description = ''
 
-configurations {
-    lic
-}
 
 dependencies {
     compile project(':subscription:bonita-test-api-sp')
@@ -13,7 +14,6 @@ dependencies {
     compile group: 'junit', name: 'junit', version: '4.12'
     testCompile group: 'org.awaitility', name: 'awaitility', version: '2.0.0'
     testCompile project(':engine:bpm:bonita-deploy:bonita-deploy-tcp')
-    lic 'org.bonitasoft.security:test-licenses:1.12.2@zip'
 }
 
 task packageTests(type: Jar) {
@@ -22,23 +22,9 @@ task packageTests(type: Jar) {
 }
 artifacts.archives packageTests
 
-task extractLicence(type: Copy) {
-    from zipTree(configurations.lic.resolvedConfiguration.resolvedArtifacts.first().file)
-    into "${project.buildDir}/lic"
-}
-
-test {
-    include ''
-}
-
-task integrationTest(type: Test) {
+integrationTest {
     include 'com/bonitasoft/engine/LocalIntegrationTestsSP.class'
-    systemProperty 'bonita.client.home', "${project.buildDir}/lic/performance"
 }
-
-task slowTest(type: Test) {
-    include 'com/bonitasoft/engine/SlowExecutionLocalIntegrationTests.class'
-    systemProperty 'bonita.client.home', "${project.buildDir}/lic/performance"
+slowTest {
+    include 'com/bonitasoft/engine/SlowExecutionLocalIntegrationTestsSP.class'
 }
-tasks.integrationTest.dependsOn extractLicence
-tasks.slowTest.dependsOn extractLicence
\ No newline at end of file
diff --git a/subscription/bonita-test-api-sp/build.gradle b/subscription/bonita-test-api-sp/build.gradle
index 55a24e32e7..c297b7051f 100644
--- a/subscription/bonita-test-api-sp/build.gradle
+++ b/subscription/bonita-test-api-sp/build.gradle
@@ -1,5 +1,13 @@
+import com.bonitasoft.engine.gradle.IntegrationTestSPPlugin
+
+apply plugin: IntegrationTestSPPlugin
+
 group = 'com.bonitasoft.engine'
 
+configurations {
+    lic
+}
+
 dependencies {
     compile project(':engine:bonita-test-api')
     compile project(':subscription:bpm:bonita-client-sp')
@@ -13,10 +21,9 @@ dependencies {
     testCompile group: 'mysql', name: 'mysql-connector-java', version: '5.1.26'
 }
 
-test {
+unitTest {
     include '**/EngineStarterSPIT.class'
 }
-
-task integrationTest(type: Test) {
+integrationTest {
     include '**/TestEngineSPIT.class'
-}
+}
\ No newline at end of file
-- 
2.17.1

