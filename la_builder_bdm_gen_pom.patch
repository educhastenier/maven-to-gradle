From cd7979a43de8ac13209b5b0e872d45bb3eb89e1d Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@gmail.com>
Date: Sat, 15 Sep 2018 15:09:06 +0200
Subject: [PATCH] fix la-builder, replace bdm-generator pom

---
 .../build.gradle                              | 20 ++++++++++++++++---
 1 file changed, 17 insertions(+), 3 deletions(-)

diff --git a/community/services/bonita-business-data/bonita-business-data-generator/build.gradle b/community/services/bonita-business-data/bonita-business-data-generator/build.gradle
index e175e39ce4..3476c6a0bc 100644
--- a/community/services/bonita-business-data/bonita-business-data-generator/build.gradle
+++ b/community/services/bonita-business-data/bonita-business-data-generator/build.gradle
@@ -1,3 +1,5 @@
+import groovy.xml.XmlUtil
+
 apply plugin: 'com.github.johnrengelman.shadow'
 apply plugin: 'maven-publish'
 
@@ -34,6 +36,7 @@ processResources {
 }
 
 shadowJar {
+//    baseName = 'myproject-shadow'
     classifier = "studio"
     dependencies {
         exclude(dependency('org.eclipse.jdt.core.compiler:ecj'))
@@ -43,11 +46,22 @@ shadowJar {
 
 publishing {
     publications {
-        shadow(MavenPublication) { publication ->
-            project.shadow.component(publication)
-        }
         mavenJava(MavenPublication) {
             from project.components.java
         }
+        shadow(MavenPublication) { publication ->
+            project.shadow.component(publication)
+            // ugly fix: replace shaded pom dependencies by the original pom dependencies (maven does that????)
+            publication.pom { pom ->
+                pom.packaging = "jar"
+                Node original
+                project.publishing.publications.mavenJava.pom.withXml { originalXml ->
+                    original = originalXml.asNode().children().find { n -> n.name().toString().endsWith("dependencies")}
+                }
+                pom.withXml { xml ->
+                    xml.asNode().children().find { n -> n.name().toString().endsWith("dependencies")}.replaceNode(original)
+                }
+            }
+        }
     }
 }
\ No newline at end of file
-- 
2.18.0

