From b9314edb02692a4a97bd16ff416546dbc52c49c1 Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@bonitasoft.com>
Date: Fri, 20 Jul 2018 16:01:06 +0200
Subject: [PATCH] add first version of shade

---
 buildSrc/build.gradle                         |  10 ++
 buildSrc/settings.gradle                      |   3 +
 community/bpm/bonita-server/build.gradle      |   1 +
 community/build.gradle                        |   1 +
 community/buildSrc/build.gradle               |  21 +++
 .../engine/gradle/ShadePlugin.groovy          | 127 ++++++++++++++++++
 subscription/bpm/bonita-server/build.gradle   |   4 +-
 7 files changed, 164 insertions(+), 3 deletions(-)
 create mode 100644 buildSrc/build.gradle
 create mode 100644 buildSrc/settings.gradle
 create mode 100644 community/buildSrc/build.gradle
 create mode 100644 community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy

diff --git a/buildSrc/build.gradle b/buildSrc/build.gradle
new file mode 100644
index 0000000000..e4c7d207f0
--- /dev/null
+++ b/buildSrc/build.gradle
@@ -0,0 +1,10 @@
+dependencies {
+    runtime subprojects
+}
+
+allprojects {
+    repositories {
+        mavenLocal()
+        jcenter()
+    }
+}
\ No newline at end of file
diff --git a/buildSrc/settings.gradle b/buildSrc/settings.gradle
new file mode 100644
index 0000000000..0de8ed0579
--- /dev/null
+++ b/buildSrc/settings.gradle
@@ -0,0 +1,3 @@
+include ':community-buildSrc'
+
+project(':community-buildSrc').projectDir = "$rootDir/../community/buildSrc" as File
\ No newline at end of file
diff --git a/community/bpm/bonita-server/build.gradle b/community/bpm/bonita-server/build.gradle
index 7b286298ee..fe549c28b0 100644
--- a/community/bpm/bonita-server/build.gradle
+++ b/community/bpm/bonita-server/build.gradle
@@ -1,6 +1,7 @@
 /*
  * This file was generated by the Gradle 'init' task.
  */
+apply plugin: 'bonita-shade'
 
 dependencies {
     compile project(':engine:bpm:bonita-core:bonita-process-engine')
diff --git a/community/build.gradle b/community/build.gradle
index a66ea9c7dc..c3e563f69b 100644
--- a/community/build.gradle
+++ b/community/build.gradle
@@ -5,6 +5,7 @@
 allprojects {
     group = 'org.bonitasoft.engine'
     version = '7.9.0-SNAPSHOT'
+    apply plugin: 'maven-publish'
 }
 
 subprojects {
diff --git a/community/buildSrc/build.gradle b/community/buildSrc/build.gradle
new file mode 100644
index 0000000000..030213f655
--- /dev/null
+++ b/community/buildSrc/build.gradle
@@ -0,0 +1,21 @@
+apply plugin: 'groovy'
+apply plugin: 'java-gradle-plugin'
+
+repositories {
+    mavenLocal()
+    jcenter()
+}
+
+dependencies {
+    compile "com.github.jengelman.gradle.plugins:shadow:2.0.4"
+}
+
+
+gradlePlugin {
+    plugins {
+        bonitaShade {
+            id = "bonita-shade"
+            implementationClass = "org.bonitasoft.engine.gradle.ShadePlugin"
+        }
+    }
+}
\ No newline at end of file
diff --git a/community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy b/community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy
new file mode 100644
index 0000000000..97e382e8bb
--- /dev/null
+++ b/community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy
@@ -0,0 +1,127 @@
+package org.bonitasoft.engine.gradle
+
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.artifacts.Dependency
+import org.gradle.api.artifacts.ProjectDependency
+import org.gradle.api.artifacts.ResolvedDependency
+import org.gradle.api.artifacts.component.ProjectComponentIdentifier
+import org.gradle.api.publish.maven.MavenPublication
+
+class ShadePlugin implements Plugin<Project> {
+    @Override
+    void apply(Project project) {
+        project.plugins.apply("com.github.johnrengelman.shadow")
+        project.plugins.apply("maven-publish")
+
+        project.shadowJar {
+            classifier = ""
+            dependencies {
+                include({
+                    isIncludedInShade(project, it)
+                })
+            }
+        }
+
+        project.publishing.publications {
+            shadow(MavenPublication) { publication ->
+                project.shadow.component(publication)
+                pom.withXml {
+
+                    Set<Dependency> inPom = getPomDependencies(project)
+                    project.logger.quiet("Include in pom:")
+                    inPom.each {
+                        project.logger.quiet(" - {}", it)
+                    }
+                    Node dependencies = asNode().children().find { Node child -> child.name() == "dependencies" }
+                    inPom.each { gradleDep ->
+                        Node dependency =
+                                dependencies
+                                        .appendNode("dependency")
+                        dependency.appendNode("groupId", gradleDep.group)
+                        dependency.appendNode("artifactId", gradleDep.name)
+                        dependency.appendNode("version", gradleDep.version)
+                    }
+                }
+            }
+            mavenJava(MavenPublication) {
+                from project.components.java
+            }
+        }
+
+    }
+
+
+    private boolean isIncludedInShade(Project project, ResolvedDependency currentDependency) {
+        if (!project.ext.has("projectsToShade")) {
+            project.ext.projectsToShade = getAllProjectsToShade(project)
+            project.logger.quiet("Shading for project {} : ", project.path)
+            project.ext.projectsToShade.each {
+                project.logger.quiet(" - {}", it)
+            }
+        }
+        Set<Project> projectsToShade = project.ext.projectsToShade
+        def projectDep = getProjectFromDependency(project, currentDependency)
+        if (projectDep == null) {
+            project.logger.info("Exclude: {} because it is not a project", currentDependency)
+            return false
+        }
+        def isIncluded = projectsToShade.contains(projectDep)
+        if (isIncluded) {
+            project.logger.info("Include: {} because it is a project", currentDependency)
+        } else {
+            project.logger.info("Exclude: {} because it is already shaded", currentDependency)
+        }
+        return isIncluded
+    }
+
+    private Project getProjectFromDependency(Project project, ResolvedDependency dependency) {
+        def identifier = dependency.getModuleArtifacts().first().id.componentIdentifier
+        if (!(identifier instanceof ProjectComponentIdentifier)) {
+            return null
+        }
+        project.project(identifier.projectPath)
+    }
+
+    private boolean isAShadeProject(Project it) {
+        it.plugins.any { p -> p instanceof ShadePlugin }
+    }
+
+    private Set<Project> getAllProjectsToShade(Project project) {
+        Set allProjects = []
+        def dependencies = project.configurations.compile.dependencies
+        dependencies.forEach {
+            if (it instanceof ProjectDependency) {
+                def projectDependency = it.dependencyProject
+                if (!isAShadeProject(projectDependency)) {
+                    allProjects.add(projectDependency)
+                    allProjects.addAll(getAllProjectsToShade(projectDependency))
+                }
+            }
+        }
+        allProjects
+    }
+
+
+    private Set<Dependency> getPomDependencies(Project project) {
+        Set allDependencies = []
+        def dependencies = project.configurations.compile.dependencies
+        dependencies.forEach {
+            if (it instanceof ProjectDependency) {
+                def projectDependency = it.dependencyProject
+                if (isAShadeProject(projectDependency)) {
+                    // the project is a shaded project (e.g. bonita-common)
+                    allDependencies.add(projectDependency)
+                } else {
+                    // do not add it: project is shaded inside this project
+                    allDependencies.addAll(getPomDependencies(projectDependency))
+                }
+            } else {
+                // external: add it in pom
+                allDependencies.add(it)
+            }
+        }
+        allDependencies
+    }
+
+}
diff --git a/subscription/bpm/bonita-server/build.gradle b/subscription/bpm/bonita-server/build.gradle
index 3ab2714550..ffc6924445 100644
--- a/subscription/bpm/bonita-server/build.gradle
+++ b/subscription/bpm/bonita-server/build.gradle
@@ -1,6 +1,4 @@
-/*
- * This file was generated by the Gradle 'init' task.
- */
+apply plugin: 'bonita-shade'
 
 dependencies {
     compile project(':engine:bpm:bonita-server')
-- 
2.20.1

