From 2e2b483262fd444ad6e105d26c9e75cd1752b104 Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@bonitasoft.com>
Date: Fri, 20 Jul 2018 16:01:06 +0200
Subject: [PATCH] add first version of shade

---
 buildSrc/build.gradle                         |  10 ++
 buildSrc/settings.gradle                      |   3 +
 community/bpm/bonita-client/build.gradle      |   3 +-
 community/bpm/bonita-common/build.gradle      |   3 +-
 community/bpm/bonita-server/build.gradle      |   1 +
 community/build.gradle                        |  22 ++-
 community/buildSrc/build.gradle               |  21 +++
 .../engine/gradle/ShadePlugin.groovy          | 127 ++++++++++++++++++
 subscription/bpm/bonita-client/build.gradle   |   2 +
 subscription/bpm/bonita-common/build.gradle   |   2 +
 subscription/bpm/bonita-server/build.gradle   |   2 +
 11 files changed, 193 insertions(+), 3 deletions(-)
 create mode 100644 buildSrc/build.gradle
 create mode 100644 buildSrc/settings.gradle
 create mode 100644 community/buildSrc/build.gradle
 create mode 100644 community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy

diff --git a/buildSrc/build.gradle b/buildSrc/build.gradle
new file mode 100644
index 0000000000..e4c7d207f0
--- /dev/null
+++ b/buildSrc/build.gradle
@@ -0,0 +1,10 @@
+dependencies {
+    runtime subprojects
+}
+
+allprojects {
+    repositories {
+        mavenLocal()
+        jcenter()
+    }
+}
\ No newline at end of file
diff --git a/buildSrc/settings.gradle b/buildSrc/settings.gradle
new file mode 100644
index 0000000000..0de8ed0579
--- /dev/null
+++ b/buildSrc/settings.gradle
@@ -0,0 +1,3 @@
+include ':community-buildSrc'
+
+project(':community-buildSrc').projectDir = "$rootDir/../community/buildSrc" as File
\ No newline at end of file
diff --git a/community/bpm/bonita-client/build.gradle b/community/bpm/bonita-client/build.gradle
index dce1d6494a..b3c53436bb 100644
--- a/community/bpm/bonita-client/build.gradle
+++ b/community/bpm/bonita-client/build.gradle
@@ -1,7 +1,8 @@
+apply plugin: 'bonita-shade'
 
 description = 'Bonita Client'
 dependencies {
   compile project(':engine:bpm:bonita-api:bonita-client-api')
   compile project(':engine:bpm:bonita-util:bonita-client-util')
   compile project(':engine:bpm:bonita-common')
-}
+}
\ No newline at end of file
diff --git a/community/bpm/bonita-common/build.gradle b/community/bpm/bonita-common/build.gradle
index 6e6b8df7dc..bb46c83d8b 100644
--- a/community/bpm/bonita-common/build.gradle
+++ b/community/bpm/bonita-common/build.gradle
@@ -1,7 +1,8 @@
+apply plugin: 'bonita-shade'
 
 description = 'Bonita Common'
 dependencies {
   compile project(':engine:bpm:bonita-api:bonita-common-api')
   compile project(':engine:bpm:bonita-api:bonita-common-api-impl')
   compile project(':engine:bpm:bonita-util:bonita-common-util')
-}
+}
\ No newline at end of file
diff --git a/community/bpm/bonita-server/build.gradle b/community/bpm/bonita-server/build.gradle
index 70c6b83171..d3fdb61ac2 100644
--- a/community/bpm/bonita-server/build.gradle
+++ b/community/bpm/bonita-server/build.gradle
@@ -1,3 +1,4 @@
+apply plugin: 'bonita-shade'
 
 description = 'Bonita Server'
 dependencies {
diff --git a/community/build.gradle b/community/build.gradle
index 446e6f35a5..bf3a0d8365 100644
--- a/community/build.gradle
+++ b/community/build.gradle
@@ -2,7 +2,27 @@ allprojects  {
   apply plugin: 'maven'
 
   group = 'org.bonitasoft.engine'
-version = '7.8.0-SNAPSHOT'
+    version = '7.8.0-SNAPSHOT'
+}
+
+allprojects {
+    apply plugin: 'maven-publish'
+
+    repositories {
+        mavenLocal()
+        maven { url "http://repositories.rd.lan/maven/all/" }
+        mavenCentral()
+        jcenter()
+    }
+
+    publishing {
+        repositories {
+            maven {
+                name 'bonitaInternal'
+                url 'http://repositories.rd.lan/maven/all/'
+            }
+        }
+    }
 }
 
 subprojects {
diff --git a/community/buildSrc/build.gradle b/community/buildSrc/build.gradle
new file mode 100644
index 0000000000..030213f655
--- /dev/null
+++ b/community/buildSrc/build.gradle
@@ -0,0 +1,21 @@
+apply plugin: 'groovy'
+apply plugin: 'java-gradle-plugin'
+
+repositories {
+    mavenLocal()
+    jcenter()
+}
+
+dependencies {
+    compile "com.github.jengelman.gradle.plugins:shadow:2.0.4"
+}
+
+
+gradlePlugin {
+    plugins {
+        bonitaShade {
+            id = "bonita-shade"
+            implementationClass = "org.bonitasoft.engine.gradle.ShadePlugin"
+        }
+    }
+}
\ No newline at end of file
diff --git a/community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy b/community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy
new file mode 100644
index 0000000000..97e382e8bb
--- /dev/null
+++ b/community/buildSrc/src/main/groovy/org/bonitasoft/engine/gradle/ShadePlugin.groovy
@@ -0,0 +1,127 @@
+package org.bonitasoft.engine.gradle
+
+import org.gradle.api.Plugin
+import org.gradle.api.Project
+import org.gradle.api.artifacts.Dependency
+import org.gradle.api.artifacts.ProjectDependency
+import org.gradle.api.artifacts.ResolvedDependency
+import org.gradle.api.artifacts.component.ProjectComponentIdentifier
+import org.gradle.api.publish.maven.MavenPublication
+
+class ShadePlugin implements Plugin<Project> {
+    @Override
+    void apply(Project project) {
+        project.plugins.apply("com.github.johnrengelman.shadow")
+        project.plugins.apply("maven-publish")
+
+        project.shadowJar {
+            classifier = ""
+            dependencies {
+                include({
+                    isIncludedInShade(project, it)
+                })
+            }
+        }
+
+        project.publishing.publications {
+            shadow(MavenPublication) { publication ->
+                project.shadow.component(publication)
+                pom.withXml {
+
+                    Set<Dependency> inPom = getPomDependencies(project)
+                    project.logger.quiet("Include in pom:")
+                    inPom.each {
+                        project.logger.quiet(" - {}", it)
+                    }
+                    Node dependencies = asNode().children().find { Node child -> child.name() == "dependencies" }
+                    inPom.each { gradleDep ->
+                        Node dependency =
+                                dependencies
+                                        .appendNode("dependency")
+                        dependency.appendNode("groupId", gradleDep.group)
+                        dependency.appendNode("artifactId", gradleDep.name)
+                        dependency.appendNode("version", gradleDep.version)
+                    }
+                }
+            }
+            mavenJava(MavenPublication) {
+                from project.components.java
+            }
+        }
+
+    }
+
+
+    private boolean isIncludedInShade(Project project, ResolvedDependency currentDependency) {
+        if (!project.ext.has("projectsToShade")) {
+            project.ext.projectsToShade = getAllProjectsToShade(project)
+            project.logger.quiet("Shading for project {} : ", project.path)
+            project.ext.projectsToShade.each {
+                project.logger.quiet(" - {}", it)
+            }
+        }
+        Set<Project> projectsToShade = project.ext.projectsToShade
+        def projectDep = getProjectFromDependency(project, currentDependency)
+        if (projectDep == null) {
+            project.logger.info("Exclude: {} because it is not a project", currentDependency)
+            return false
+        }
+        def isIncluded = projectsToShade.contains(projectDep)
+        if (isIncluded) {
+            project.logger.info("Include: {} because it is a project", currentDependency)
+        } else {
+            project.logger.info("Exclude: {} because it is already shaded", currentDependency)
+        }
+        return isIncluded
+    }
+
+    private Project getProjectFromDependency(Project project, ResolvedDependency dependency) {
+        def identifier = dependency.getModuleArtifacts().first().id.componentIdentifier
+        if (!(identifier instanceof ProjectComponentIdentifier)) {
+            return null
+        }
+        project.project(identifier.projectPath)
+    }
+
+    private boolean isAShadeProject(Project it) {
+        it.plugins.any { p -> p instanceof ShadePlugin }
+    }
+
+    private Set<Project> getAllProjectsToShade(Project project) {
+        Set allProjects = []
+        def dependencies = project.configurations.compile.dependencies
+        dependencies.forEach {
+            if (it instanceof ProjectDependency) {
+                def projectDependency = it.dependencyProject
+                if (!isAShadeProject(projectDependency)) {
+                    allProjects.add(projectDependency)
+                    allProjects.addAll(getAllProjectsToShade(projectDependency))
+                }
+            }
+        }
+        allProjects
+    }
+
+
+    private Set<Dependency> getPomDependencies(Project project) {
+        Set allDependencies = []
+        def dependencies = project.configurations.compile.dependencies
+        dependencies.forEach {
+            if (it instanceof ProjectDependency) {
+                def projectDependency = it.dependencyProject
+                if (isAShadeProject(projectDependency)) {
+                    // the project is a shaded project (e.g. bonita-common)
+                    allDependencies.add(projectDependency)
+                } else {
+                    // do not add it: project is shaded inside this project
+                    allDependencies.addAll(getPomDependencies(projectDependency))
+                }
+            } else {
+                // external: add it in pom
+                allDependencies.add(it)
+            }
+        }
+        allDependencies
+    }
+
+}
diff --git a/subscription/bpm/bonita-client/build.gradle b/subscription/bpm/bonita-client/build.gradle
index 96b4e2d27c..9ffaac288c 100644
--- a/subscription/bpm/bonita-client/build.gradle
+++ b/subscription/bpm/bonita-client/build.gradle
@@ -1,3 +1,5 @@
+apply plugin: 'bonita-shade'
+
 group = 'com.bonitasoft.engine'
 description = 'Bonita Client SP'
 dependencies {
diff --git a/subscription/bpm/bonita-common/build.gradle b/subscription/bpm/bonita-common/build.gradle
index 17e8270510..2cc7b2c899 100644
--- a/subscription/bpm/bonita-common/build.gradle
+++ b/subscription/bpm/bonita-common/build.gradle
@@ -1,3 +1,5 @@
+apply plugin: 'bonita-shade'
+
 group = 'com.bonitasoft.engine'
 description = 'Bonita Common SP'
 dependencies {
diff --git a/subscription/bpm/bonita-server/build.gradle b/subscription/bpm/bonita-server/build.gradle
index 324ea487b0..1a7546f0dc 100644
--- a/subscription/bpm/bonita-server/build.gradle
+++ b/subscription/bpm/bonita-server/build.gradle
@@ -1,3 +1,5 @@
+apply plugin: 'bonita-shade'
+
 group = 'com.bonitasoft.engine'
 description = 'Bonita Server SP'
 dependencies {
-- 
2.18.0

