From ba792fb69ee2bc2378adf1399925b178e169f72e Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@bonitasoft.com>
Date: Mon, 16 Jul 2018 16:47:02 +0200
Subject: [PATCH] use JVM flag for memory mngmt in docker

should factorise the code to get jvm options
---
 Jenkinsfile            |  2 +-
 build.gradle           | 15 ++++++++++++++-
 community/build.gradle | 17 ++++++++++++++++-
 gradle.properties      |  1 +
 4 files changed, 32 insertions(+), 3 deletions(-)
 create mode 100644 gradle.properties

diff --git a/Jenkinsfile b/Jenkinsfile
index be7f729ac1..678094f916 100644
--- a/Jenkinsfile
+++ b/Jenkinsfile
@@ -18,7 +18,7 @@ timestamps {
 
             try {
                  stage('Build and Test') {
-                     sh './gradlew build iT'
+                     sh './gradlew build iT --info -Dorg.gradle.jvmargs="-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"'
                  }
             } finally {
                 junit '**/build/test-results/**/*.xml'
diff --git a/build.gradle b/build.gradle
index aa0258c1d5..5cc5eef880 100644
--- a/build.gradle
+++ b/build.gradle
@@ -23,7 +23,20 @@ subprojects {
     maven { url "https://oss.sonatype.org/content/repositories/snapshots" }
   }
 
-  
+  afterEvaluate {
+    tasks.withType(Test) { testTask ->
+      if (testTask.name == "integrationTest" || testTask.name == "slowtest") {
+        def property = project.property('org.gradle.jvmargs')
+        if(property){
+          jvmArgs property.toString().split(" ")
+        }
+        def sysProperty = System.getProperty("org.gradle.jvmargs")
+        if (sysProperty) {
+          jvmArgs sysProperty.split(" ")
+        }
+      }
+    }
+  }
   
   
 }
diff --git a/community/build.gradle b/community/build.gradle
index e46185d95c..446e6f35a5 100644
--- a/community/build.gradle
+++ b/community/build.gradle
@@ -19,7 +19,22 @@ subprojects {
 classifier = 'sources'
 from sourceSets.main.allSource
 
-}
+      afterEvaluate {
+          tasks.withType(Test) { testTask ->
+              if (testTask.name == "integrationTest" || testTask.name == "slowtest") {
+                  def property = project.property('org.gradle.jvmargs')
+                  if (property) {
+                      jvmArgs property.toString().split(" ")
+                  }
+                  def sysProperty = System.getProperty("org.gradle.jvmargs")
+                  if (sysProperty) {
+                      jvmArgs sysProperty.split(" ")
+                  }
+              }
+          }
+      }
+
+  }
 artifacts.archives packageSources
   repositories {
     mavenLocal()
diff --git a/gradle.properties b/gradle.properties
new file mode 100644
index 0000000000..656f2e6098
--- /dev/null
+++ b/gradle.properties
@@ -0,0 +1 @@
+org.gradle.jvmargs=-Dfile.encoding=UTF-8
\ No newline at end of file
-- 
2.17.1

