From 3cf4fff7c95eac6fd09bcfca4b1965ef7ab74bc9 Mon Sep 17 00:00:00 2001
From: Baptiste Mesta <baptiste.mesta@bonitasoft.com>
Date: Mon, 16 Jul 2018 16:47:02 +0200
Subject: [PATCH] use JVM flag for memory mngmt in docker

should factorise the code to get jvm options
---
 Jenkinsfile            |  6 +++---
 build.gradle           | 15 ++++++++++++++-
 community/build.gradle | 17 ++++++++++++++++-
 gradle.properties      |  1 +
 4 files changed, 34 insertions(+), 5 deletions(-)
 create mode 100644 gradle.properties

diff --git a/Jenkinsfile b/Jenkinsfile
index b2f73529646..06cb5772d5e 100644
--- a/Jenkinsfile
+++ b/Jenkinsfile
@@ -17,9 +17,9 @@ timestamps {
             }
 
             try {
-                    stage('Build and Test') {
-                     sh './gradlew build iT'
-                }
+                 stage('Build and Test') {
+                     sh './gradlew build iT -Dorg.gradle.jvmargs="-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"'
+                 }
             } finally {
                 junit '**/build/test-results/**/*.xml'
             }
diff --git a/build.gradle b/build.gradle
index 809b7697439..f191f2d46e3 100644
--- a/build.gradle
+++ b/build.gradle
@@ -18,7 +18,20 @@ subprojects {
     maven { url "http://repo.maven.apache.org/maven2" }
   }
 
-  
+  afterEvaluate {
+    tasks.withType(Test) { testTask ->
+      if (testTask.name == "integrationTest" || testTask.name == "slowtest") {
+        def property = project.property('org.gradle.jvmargs')
+        if(property){
+          jvmArgs property.toString().split(" ")
+        }
+        def sysProperty = System.getProperty("org.gradle.jvmargs")
+        if (sysProperty) {
+          jvmArgs sysProperty.split(" ")
+        }
+      }
+    }
+  }
   
   
 }
diff --git a/community/build.gradle b/community/build.gradle
index a90e67954cf..858ef6fe3cd 100644
--- a/community/build.gradle
+++ b/community/build.gradle
@@ -19,7 +19,22 @@ subprojects {
 classifier = 'sources'
 from sourceSets.main.allSource
 
-}
+      afterEvaluate {
+          tasks.withType(Test) { testTask ->
+              if (testTask.name == "integrationTest" || testTask.name == "slowtest") {
+                  def property = project.property('org.gradle.jvmargs')
+                  if (property) {
+                      jvmArgs property.toString().split(" ")
+                  }
+                  def sysProperty = System.getProperty("org.gradle.jvmargs")
+                  if (sysProperty) {
+                      jvmArgs sysProperty.split(" ")
+                  }
+              }
+          }
+      }
+
+  }
 artifacts.archives packageSources
   repositories {
     mavenLocal()
diff --git a/gradle.properties b/gradle.properties
new file mode 100644
index 00000000000..656f2e60988
--- /dev/null
+++ b/gradle.properties
@@ -0,0 +1 @@
+org.gradle.jvmargs=-Dfile.encoding=UTF-8
\ No newline at end of file
-- 
2.17.1

